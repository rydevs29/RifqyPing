<!DOCTYPE html>
<html lang="id" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EdgePulse v4.0 - Forensic Network Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { darkBg: '#050505', glassBg: '#111111', border: '#222' } } }
        }
    </script>
    <style>
        :root { --neon: #00f2fe; --neon-glow: rgba(0, 242, 254, 0.6); }
        body { background-color: #050505; color: #ededed; font-family: 'Inter', sans-serif; overflow-x: hidden; }
        .text-neon { color: var(--neon); }
        .bg-neon { background-color: var(--neon); color: #000; }
        .border-neon { border-color: var(--neon); }
        .glass { background: rgba(17, 17, 17, 0.7); backdrop-filter: blur(16px); border: 1px solid #222; box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5); }
        .neon-glow { text-shadow: 0 0 15px var(--neon-glow); }
        .tab-content { display: none; opacity: 0; transform: translateY(10px); transition: all 0.4s ease; }
        .tab-content.active { display: block; opacity: 1; transform: translateY(0); }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #050505; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--neon); }
        .theme-btn { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; }
        .theme-btn:hover { border-color: white; transform: scale(1.1); }
    </style>
</head>
<body class="min-h-screen flex flex-col md:flex-row">

    <div class="md:hidden fixed top-0 w-full glass z-50 p-4 flex justify-between items-center">
        <button onclick="toggleSidebar()" class="text-neon text-2xl px-2"><i class="fa-solid fa-bars-staggered"></i></button>
        <span class="font-black text-white tracking-widest uppercase">Edge<span class="text-neon">Pulse</span></span>
        <div class="w-8"></div>
    </div>

    <aside id="sidebar" class="fixed md:static h-full w-72 glass z-40 transform -translate-x-full md:translate-x-0 transition-transform duration-300 flex flex-col pt-20 md:pt-0 overflow-y-auto">
        <div class="p-6 hidden md:flex items-center gap-4 border-b border-border">
            <i class="fa-solid fa-shield-halved text-neon text-2xl"></i>
            <h1 class="text-2xl font-black tracking-tighter text-white uppercase">Edge<span class="text-neon">Pulse</span><span class="text-[10px] align-top ml-1 text-gray-500">v4</span></h1>
        </div>

        <nav class="flex flex-col gap-1 flex-1 p-4 overflow-y-auto">
            <div class="text-xs font-bold text-gray-600 mb-2 mt-2 px-2 tracking-widest">DIAGNOSTICS</div>
            <button onclick="switchTab('dash')" class="nav-btn active flex items-center gap-3 p-3 rounded-xl bg-neon/10 text-neon font-bold transition">
                <i class="fa-solid fa-gauge-high w-5"></i> Network Health
            </button>
            <button onclick="switchTab('bufferbloat')" class="nav-btn flex items-center gap-3 p-3 rounded-xl text-gray-400 hover:text-white transition">
                <i class="fa-solid fa-truck-fast w-5"></i> Bufferbloat & Load
            </button>
            <button onclick="switchTab('global')" class="nav-btn flex items-center gap-3 p-3 rounded-xl text-gray-400 hover:text-white transition">
                <i class="fa-solid fa-earth-asia w-5"></i> Global Map & Hops
            </button>
            
            <div class="text-xs font-bold text-gray-600 mb-2 mt-6 px-2 tracking-widest">FORENSICS LAB</div>
            <button onclick="switchTab('forensic')" class="nav-btn flex items-center gap-3 p-3 rounded-xl text-gray-400 hover:text-white transition">
                <i class="fa-solid fa-user-secret w-5"></i> MTU & WS vs HTTP
            </button>
            <button onclick="switchTab('dot')" class="nav-btn flex items-center gap-3 p-3 rounded-xl text-gray-400 hover:text-white transition">
                <i class="fa-solid fa-lock w-5"></i> DNS Hijack Check
            </button>
            <button onclick="switchTab('tools')" class="nav-btn flex items-center gap-3 p-3 rounded-xl text-gray-400 hover:text-white transition">
                <i class="fa-solid fa-map-location-dot w-5"></i> IP Geospatial
            </button>

            <div class="text-xs font-bold text-gray-600 mb-2 mt-6 px-2 tracking-widest">SYSTEM</div>
            <button onclick="switchTab('history')" class="nav-btn flex items-center gap-3 p-3 rounded-xl text-gray-400 hover:text-white transition">
                <i class="fa-solid fa-clock-rotate-left w-5"></i> Local History
            </button>
        </nav>
        
        <div class="p-4 border-t border-border bg-black/20">
            <div class="flex gap-2 justify-center mb-4">
                <div class="theme-btn" style="background: #00f2fe;" onclick="changeTheme('#00f2fe')"></div>
                <div class="theme-btn" style="background: #00ff66;" onclick="changeTheme('#00ff66')"></div>
                <div class="theme-btn" style="background: #ff0055;" onclick="changeTheme('#ff0055')"></div>
                <div class="theme-btn" style="background: #ffcc00;" onclick="changeTheme('#ffcc00')"></div>
            </div>
            <button onclick="generateReport()" class="w-full bg-gray-800 hover:bg-gray-700 text-white p-3 rounded-xl text-sm font-bold transition flex items-center justify-center gap-2">
                <i class="fa-solid fa-copy"></i> Generate ISP Report
            </button>
        </div>
    </aside>

    <div id="overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-30 hidden md:hidden"></div>

    <main class="flex-1 p-4 md:p-8 pt-24 md:pt-8 overflow-y-auto w-full">
        
        <div id="dash" class="tab-content active max-w-5xl mx-auto">
            <div class="flex justify-between items-end mb-6">
                <div><h2 class="text-3xl font-black text-white">System <span class="text-neon">Dashboard</span></h2></div>
                <button onclick="runAutoTest()" class="bg-neon font-bold px-6 py-2 rounded-xl hover:opacity-80 transition hidden md:block"><i class="fa-solid fa-rotate-right"></i> Run Analysis</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="glass p-8 rounded-3xl md:col-span-2 flex flex-col items-center justify-center text-center">
                    <div class="text-xs text-gray-500 font-bold tracking-widest mb-2">IDLE LATENCY (TCP)</div>
                    <div id="main-ping" class="text-8xl md:text-9xl font-black neon-glow mt-2">--<span class="text-3xl">ms</span></div>
                    <div id="ping-status" class="mt-6 px-6 py-2 rounded-full bg-gray-900 border border-gray-700 text-gray-400 text-sm font-bold">STANDBY</div>
                </div>
                <div class="glass p-6 rounded-3xl flex flex-col justify-between">
                    <div>
                        <h3 class="text-sm font-bold text-gray-400 border-b border-border pb-2 mb-4">ROUTING PROFILE</h3>
                        <ul class="space-y-3 text-sm">
                            <li class="flex justify-between"><span class="text-gray-500">Public IP</span> <strong id="geo-ip">...</strong></li>
                            <li class="flex justify-between"><span class="text-gray-500">ISP</span> <strong id="geo-isp">...</strong></li>
                            <li class="flex justify-between"><span class="text-gray-500">Node</span> <strong id="geo-node" class="text-neon font-mono">...</strong></li>
                        </ul>
                    </div>
                </div>
            </div>
            <button onclick="runAutoTest()" class="md:hidden mt-4 w-full bg-neon font-bold px-6 py-3 rounded-xl">RUN ANALYSIS</button>
        </div>

        <div id="bufferbloat" class="tab-content max-w-5xl mx-auto">
            <h2 class="text-3xl font-black mb-2">Bufferbloat <span class="text-neon">Analysis</span></h2>
            <p class="text-gray-500 mb-6">Mendeteksi router "ngos-ngosan". Mengukur kenaikan ping saat ada trafik berat.</p>
            
            <button onclick="runBufferbloatTest()" id="btn-bloat" class="mb-6 bg-white text-black font-bold px-8 py-3 rounded-xl hover:bg-gray-200 transition">Mulai Stress Test</button>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="glass p-6 rounded-3xl text-center"><div class="text-xs text-gray-500 mb-2">PING SAAT IDLE</div><div id="bb-idle" class="text-5xl font-black">--</div></div>
                <div class="glass p-6 rounded-3xl text-center border-2 border-red-500/30 bg-red-900/10"><div class="text-xs text-gray-500 mb-2">PING SAAT DOWNLOAD</div><div id="bb-load" class="text-5xl font-black text-red-400">--</div></div>
                <div class="glass p-6 rounded-3xl text-center"><div class="text-xs text-gray-500 mb-2">STATUS ROUTER</div><div id="bb-status" class="text-2xl font-bold mt-4 text-gray-600">Menunggu Tes</div></div>
            </div>
            <p class="text-xs text-gray-500 mt-4"><i class="fa-solid fa-info-circle"></i> Jika ping saat download naik >100ms dari idle, router Anda mengalami Bufferbloat parah. Solusi: Aktifkan QoS / SQM di router.</p>
        </div>

        <div id="forensic" class="tab-content max-w-5xl mx-auto">
            <h2 class="text-3xl font-black mb-6">Forensic <span class="text-neon">Network Lab</span></h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="glass p-6 rounded-3xl">
                    <h3 class="font-bold text-white mb-2"><i class="fa-solid fa-code-compare text-neon"></i> Traffic Shaping Detector</h3>
                    <p class="text-xs text-gray-500 mb-4">Membandingkan jalur HTTP (Web) vs WebSocket (Game/Real-time). Beda jauh = ISP pilih kasih (QoS throttling).</p>
                    <button onclick="testProtocols()" id="btn-proto" class="bg-gray-800 text-white px-4 py-2 rounded-lg text-sm mb-4">Mulai Komparasi</button>
                    <div class="flex justify-between border-b border-border pb-2 mb-2"><span class="text-gray-400">HTTP/REST Latency</span> <span id="res-http" class="font-bold">-- ms</span></div>
                    <div class="flex justify-between"><span class="text-gray-400">WebSocket Latency</span> <span id="res-ws" class="font-bold">-- ms</span></div>
                </div>

                <div class="glass p-6 rounded-3xl">
                    <h3 class="font-bold text-white mb-2"><i class="fa-solid fa-box-open text-neon"></i> MTU Fragmentation Check</h3>
                    <p class="text-xs text-gray-500 mb-4">Menembakkan paket data ukuran besar. Jika gagal/lambat, ubah MTU di router Anda ke angka yang lolos.</p>
                    <button onclick="testMTU()" id="btn-mtu" class="bg-gray-800 text-white px-4 py-2 rounded-lg text-sm mb-4">Tes Payload MTU</button>
                    <div class="flex justify-between border-b border-border pb-2 mb-2"><span class="text-gray-400">Payload 1400 Bytes</span> <span id="mtu-1400" class="font-bold">--</span></div>
                    <div class="flex justify-between border-b border-border pb-2 mb-2"><span class="text-gray-400">Payload 1492 Bytes</span> <span id="mtu-1492" class="font-bold">--</span></div>
                    <div class="flex justify-between"><span class="text-gray-400">Payload 1500 Bytes</span> <span id="mtu-1500" class="font-bold">--</span></div>
                </div>
            </div>
        </div>

        <div id="global" class="tab-content max-w-5xl mx-auto">
            <h2 class="text-3xl font-black mb-6">Global Routing & <span class="text-neon">Hops</span></h2>
            
            <div class="glass p-6 rounded-3xl mb-6">
                <h3 class="font-bold mb-2">Traceroute Estimator (Logic Based)</h3>
                <p class="text-xs text-gray-500 mb-4">Menganalisis jarak IP Anda ke Vercel Singapura dan mengestimasi jumlah lompatan server (Hops) berdasarkan RTT (Round Trip Time).</p>
                <button onclick="estimateHops()" class="bg-neon text-black font-bold px-4 py-2 rounded-lg text-sm">Analisa Rute Saya</button>
                <div id="hop-result" class="mt-4 p-4 bg-black/50 rounded-xl font-mono text-sm text-green-400 hidden"></div>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <button onclick="pingRegion('sin1')" class="glass p-4 rounded-xl text-left hover:border-neon"><div class="text-xs text-gray-500">Singapore</div><div class="font-bold">sin1</div><div id="r-sin1" class="text-xl font-black mt-1">--</div></button>
                <button onclick="pingRegion('hkg1')" class="glass p-4 rounded-xl text-left hover:border-neon"><div class="text-xs text-gray-500">Hong Kong</div><div class="font-bold">hkg1</div><div id="r-hkg1" class="text-xl font-black mt-1">--</div></button>
                <button onclick="pingRegion('hnd1')" class="glass p-4 rounded-xl text-left hover:border-neon"><div class="text-xs text-gray-500">Tokyo</div><div class="font-bold">hnd1</div><div id="r-hnd1" class="text-xl font-black mt-1">--</div></button>
                <button onclick="pingRegion('iad1')" class="glass p-4 rounded-xl text-left hover:border-neon"><div class="text-xs text-gray-500">Washington US</div><div class="font-bold">iad1</div><div id="r-iad1" class="text-xl font-black mt-1">--</div></button>
            </div>
        </div>

        <div id="dot" class="tab-content max-w-4xl mx-auto">
            <h2 class="text-3xl font-black mb-6">DNS Hijack <span class="text-neon">Detector</span></h2>
            <div class="glass p-6 rounded-3xl mb-6">
                <div class="flex gap-2 mb-4">
                    <input type="text" id="dot-in" placeholder="dns.adguard-dns.com" class="flex-1 bg-black/50 border border-gray-700 rounded-xl px-4 py-3 text-white outline-none focus:border-neon">
                    <button onclick="testDoT()" class="bg-neon text-black font-bold px-6 py-3 rounded-xl">TEST</button>
                </div>
                <div class="text-xs text-gray-400">Jika DNS Gagal/Timeout padahal internet jalan, kemungkinan besar ISP memblokir port 853 atau membajak jalur DNS Anda (Transparent Proxy).</div>
            </div>
            <div class="glass p-6 rounded-3xl text-center"><div class="text-xs text-gray-500 mb-2">DNS RESOLUTION TIME</div><div id="dot-res" class="text-5xl font-black">-- ms</div></div>
        </div>

        <div id="tools" class="tab-content max-w-4xl mx-auto">
            <h2 class="text-3xl font-black mb-6">IP <span class="text-neon">Geospatial</span></h2>
            <div class="flex gap-2 mb-6">
                <input type="text" id="ip-in" placeholder="Masukkan IP address..." class="flex-1 bg-glassBg border border-gray-700 rounded-xl px-4 py-3 text-white">
                <button onclick="lookupIP()" class="bg-white text-black font-bold px-6 py-3 rounded-xl">LOOKUP</button>
            </div>
            <div id="lookup-res" class="glass p-6 rounded-3xl hidden"><pre id="lookup-json" class="text-xs text-neon font-mono overflow-x-auto"></pre></div>
        </div>

        <div id="history" class="tab-content max-w-5xl mx-auto">
            <h2 class="text-3xl font-black mb-6">Local <span class="text-neon">History</span></h2>
            <div class="glass p-6 rounded-3xl overflow-x-auto">
                <table class="w-full text-left text-sm">
                    <thead><tr class="text-gray-500 border-b border-border"><th class="pb-2">Waktu</th><th class="pb-2">Ping</th><th class="pb-2">Node</th><th class="pb-2">ISP</th></tr></thead>
                    <tbody id="history-body"></tbody>
                </table>
                <button onclick="clearHistory()" class="mt-4 text-xs text-red-500 hover:text-red-400">Clear History</button>
            </div>
        </div>

    </main>

    <script>
        // --- Core Base & Themes ---
        let reportData = {};
        
        function toggleSidebar() { 
            document.getElementById('sidebar').classList.toggle('-translate-x-full'); 
            document.getElementById('overlay').classList.toggle('hidden');
        }

        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => {
                b.className = 'nav-btn flex items-center gap-3 p-3 rounded-xl text-gray-400 hover:text-white transition';
            });
            event.currentTarget.className = 'nav-btn active flex items-center gap-3 p-3 rounded-xl bg-neon/10 text-neon font-bold transition';
            if(window.innerWidth < 768) toggleSidebar();
            if(id === 'history') loadHistory();
        }

        function changeTheme(color) {
            document.documentElement.style.setProperty('--neon', color);
            document.documentElement.style.setProperty('--neon-glow', color + '99');
        }

        async function fetchPing(url, options = {}) {
            const start = performance.now();
            try {
                const bypassUrl = url.includes('?') ? `${url}&_t=${Date.now()}` : `${url}?_t=${Date.now()}`;
                const res = await fetch(bypassUrl, { cache: 'no-store', ...options });
                if (!res.ok) throw new Error();
                return Math.round(performance.now() - start);
            } catch (e) { return 'ERR'; }
        }

        // --- Fitur 1: Dashboard ---
        async function runAutoTest() {
            document.getElementById('main-ping').innerHTML = '<i class="fa-solid fa-spinner fa-spin text-5xl"></i>';
            const geo = await fetch('/api/geo').then(r => r.json()).catch(()=>({ip:'?', city:'?', node:'?'}));
            document.getElementById('geo-ip').innerText = geo.ip;
            document.getElementById('geo-isp').innerText = geo.city;
            document.getElementById('geo-node').innerText = geo.node;
            
            const latency = await fetchPing('/api/ping');
            document.getElementById('main-ping').innerHTML = latency === 'ERR' ? 'ERR' : `${latency}<span class="text-3xl">ms</span>`;
            document.getElementById('main-ping').className = latency > 150 ? "text-8xl font-black text-red-500 mt-2" : "text-8xl font-black text-neon neon-glow mt-2";
            
            reportData = { date: new Date().toLocaleString(), ping: latency, node: geo.node, isp: geo.city };
            saveHistory(reportData);
        }

        // --- Fitur 2: Bufferbloat Test ---
        async function runBufferbloatTest() {
            const btn = document.getElementById('btn-bloat');
            btn.innerText = "Testing Idle..."; btn.disabled = true;
            
            // 1. Idle Ping
            let idlePings = [];
            for(let i=0; i<5; i++) { idlePings.push(await fetchPing('/api/ping')); await new Promise(r=>setTimeout(r,100)); }
            const idleAvg = Math.round(idlePings.reduce((a,b)=>a+b,0)/5);
            document.getElementById('bb-idle').innerText = idleAvg + ' ms';

            // 2. Load Ping (Download Dummy Data 10MB dari Cloudflare Speedtest API)
            btn.innerText = "Downloading Dummy Data (Stress)...";
            let loadPings = [];
            
            // Mulai download di background tanpa await penuh
            const downloadPromise = fetch('https://speed.cloudflare.com/__down?bytes=10000000', {cache: 'no-store'}).catch(e=>console.log("DL Err"));
            
            // Selama download, kita nembak ping
            for(let i=0; i<8; i++) {
                loadPings.push(await fetchPing('/api/ping'));
                await new Promise(r=>setTimeout(r,200));
            }
            
            const loadAvg = Math.round(loadPings.reduce((a,b)=>a+b,0)/8);
            document.getElementById('bb-load').innerText = loadAvg + ' ms';
            
            const diff = loadAvg - idleAvg;
            const statEl = document.getElementById('bb-status');
            if(diff < 20) { statEl.innerText = "A (Sangat Baik)"; statEl.className = "text-2xl font-bold mt-4 text-green-400"; }
            else if(diff < 80) { statEl.innerText = "C (Buruk)"; statEl.className = "text-2xl font-bold mt-4 text-yellow-400"; }
            else { statEl.innerText = "F (Parah / Bloated)"; statEl.className = "text-2xl font-bold mt-4 text-red-500"; }
            
            reportData.bufferbloat_diff = diff;
            btn.innerText = "Ulangi Stress Test"; btn.disabled = false;
        }

        // --- Fitur 3: Forensic Lab (HTTP vs WS & MTU) ---
        async function testProtocols() {
            document.getElementById('btn-proto').innerText = "Testing...";
            // HTTP
            const httpLat = await fetchPing('/api/ping');
            document.getElementById('res-http').innerText = httpLat + ' ms';
            
            // WebSocket
            const startWs = performance.now();
            try {
                const ws = new WebSocket('wss://echo.websocket.events');
                ws.onopen = () => { ws.send('ping'); };
                ws.onmessage = () => { 
                    document.getElementById('res-ws').innerText = Math.round(performance.now() - startWs) + ' ms';
                    ws.close();
                };
                ws.onerror = () => document.getElementById('res-ws').innerText = 'Blocked';
            } catch(e) { document.getElementById('res-ws').innerText = 'Blocked'; }
            
            document.getElementById('btn-proto').innerText = "Selesai";
        }

        async function testMTU() {
            document.getElementById('btn-mtu').innerText = "Testing Payloads...";
            const sizes = [1400, 1492, 1500];
            for(let size of sizes) {
                const dummyData = 'A'.repeat(size);
                const lat = await fetchPing('/api/ping', { method: 'POST', body: dummyData });
                document.getElementById(`mtu-${size}`).innerText = lat === 'ERR' ? 'Drop / Fragmented' : lat + ' ms';
                document.getElementById(`mtu-${size}`).className = lat === 'ERR' ? "font-bold text-red-500" : "font-bold text-green-400";
            }
            document.getElementById('btn-mtu').innerText = "Tes Payload MTU";
        }

        // --- Fitur 4: Traceroute Estimator ---
        async function estimateHops() {
            const box = document.getElementById('hop-result');
            box.style.display = 'block';
            box.innerHTML = "Memulai Trace ke sin1.vercel.app...<br>";
            
            const ping = await fetchPing('/api/ping?region=sin1');
            box.innerHTML += `Round Trip Time: ${ping}ms<br>`;
            
            setTimeout(() => {
                if(ping === 'ERR') { box.innerHTML += "<span class='text-red-500'>[!] Request Timeout. ICMP/TCP blocked.</span>"; return; }
                let hops = ping < 30 ? 6 : (ping < 80 ? 11 : (ping < 150 ? 15 : 22));
                let diagnosis = ping > 150 ? "TERDETEKSI ROUTING LOOP / NYASAR KE AMERIKA." : "Rute Normal & Langsung.";
                
                let hopText = "";
                for(let i=1; i<=hops; i++) { hopText += `Hop ${i}: ${Math.floor(Math.random() * (ping/hops))}ms - ${i===hops?'Vercel Edge SIN1':'ISP Backbone Node'}<br>`; }
                box.innerHTML += `<br>${hopText}<br><span class="text-neon">=> Estimasi: ${hops} Hops. <br>=> Diagnosa: ${diagnosis}</span>`;
            }, 1000);
        }

        // --- History Logic ---
        function saveHistory(data) {
            if(data.ping === 'ERR') return;
            let hist = JSON.parse(localStorage.getItem('ep_hist') || '[]');
            hist.unshift(data);
            if(hist.length > 20) hist.pop(); // Max 20 entry
            localStorage.setItem('ep_hist', JSON.stringify(hist));
        }
        function loadHistory() {
            const hist = JSON.parse(localStorage.getItem('ep_hist') || '[]');
            const tbody = document.getElementById('history-body');
            tbody.innerHTML = hist.map(h => `<tr><td class="py-2 text-xs">${h.date}</td><td class="text-neon font-bold">${h.ping}ms</td><td>${h.node}</td><td>${h.isp}</td></tr>`).join('');
        }
        function clearHistory() { localStorage.removeItem('ep_hist'); loadHistory(); }

        // --- Utility ---
        function generateReport() {
            const txt = `=== EDGEPULSE v4 FORENSIC REPORT ===\nDate: ${reportData.date}\nISP: ${reportData.isp}\nBase Ping: ${reportData.ping}ms\nBufferbloat Spike: +${reportData.bufferbloat_diff || 'N/A'}ms\nTarget Node: ${reportData.node}\n\n*Generated by EdgePulse Network Suite*`;
            navigator.clipboard.writeText(txt); alert("Laporan dicopy!");
        }
        async function pingRegion(reg) {
            const el = document.getElementById(`r-${reg}`);
            el.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
            const lat = await fetchPing(`/api/ping?region=${reg}`);
            el.innerHTML = lat === 'ERR' ? '<span class="text-red-500">ERR</span>' : `${lat} <span class="text-sm">ms</span>`;
        }
        async function testDoT() {
            const d = document.getElementById('dot-in').value || 'dns.google';
            const el = document.getElementById('dot-res');
            el.innerHTML = '...';
            const lat = await fetchPing(`/api/dot?server=${d}`);
            el.innerText = lat === 'ERR' ? 'BLOCKED' : lat + ' ms';
            el.className = lat === 'ERR' ? "text-5xl font-black text-red-500" : "text-5xl font-black text-neon";
        }
        async function lookupIP() {
            const res = await fetch(`/api/lookup?ip=${document.getElementById('ip-in').value}`).then(r=>r.json());
            document.getElementById('lookup-res').style.display='block';
            document.getElementById('lookup-json').innerText = JSON.stringify(res, null, 2);
        }

        window.onload = runAutoTest;
    </script>
</body>
</html>
